import os
import telebot
from flask import Flask, request

# –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Render
TOKEN = os.getenv("TELEGRAM_TOKEN")
ADMIN_CHAT_ID = os.getenv("ADMIN_CHAT_ID")
WEBHOOK_URL = os.getenv("RENDER_EXTERNAL_URL")  # Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç —ç—Ç–æ—Ç URL

# –ü—Ä–æ–≤–µ—Ä–∫–∞
if not TOKEN:
    print("‚ùå –û–®–ò–ë–ö–ê: TELEGRAM_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    exit(1)

if not ADMIN_CHAT_ID:
    print("‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: ADMIN_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –±—É–¥—É—Ç –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å—Å—è.")

# –°–æ–∑–¥–∞–µ–º –±–æ—Ç–∞ –∏ Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
bot = telebot.TeleBot(TOKEN)
app = Flask(__name__)

# ========== –ö–û–ú–ê–ù–î–´ –ë–û–¢–ê ==========

@bot.message_handler(commands=['start'])
def send_welcome(message):
    welcome_text = (
        "üëª *–ê–Ω–æ–Ω–∏–º–Ω—ã–π –±–æ—Ç*\n\n"
        "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.\n"
        "–ù–∞–ø–∏—à–∏ —Å—é–¥–∞ —á—Ç–æ —É–≥–æ–¥–Ω–æ, –∏ —è –ø–µ—Ä–µ—à–ª—é —ç—Ç–æ –∞–¥–º–∏–Ω—É *–±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —Ç–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏*.\n\n"
        "–ú–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å:\n"
        "‚Ä¢ –¢–µ–∫—Å—Ç üìù\n‚Ä¢ –§–æ—Ç–æ üñºÔ∏è\n‚Ä¢ –í–∏–¥–µ–æ üé•\n‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç—ã üìé\n"
        "‚Ä¢ –ì–æ–ª–æ—Å–æ–≤—ã–µ üé§\n‚Ä¢ –°—Ç–∏–∫–µ—Ä—ã üòÑ\n\n"
        "_–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å —Ñ–∞–π–ª_"
    )
    bot.reply_to(message, welcome_text, parse_mode='Markdown')

@bot.message_handler(commands=['help'])
def send_help(message):
    help_text = (
        "‚ÑπÔ∏è *–ü–æ–º–æ—â—å*\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª, –∏ –æ–Ω–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–ª–∞–Ω–æ –∞–¥–º–∏–Ω—É –∞–Ω–æ–Ω–∏–º–Ω–æ.\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\n"
        "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
        "/privacy - –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å\n\n"
        "_–í–∞—à–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è_"
    )
    bot.reply_to(message, help_text, parse_mode='Markdown')

@bot.message_handler(commands=['privacy'])
def send_privacy(message):
    privacy_text = (
        "üîí *–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å*\n\n"
        "‚Ä¢ –Ø –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é –≤–∞—à–∏ –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n"
        "‚Ä¢ –Ø –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞—é –∞–¥–º–∏–Ω—É –≤–∞—à ID, –∏–º—è –∏–ª–∏ username\n"
        "‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ—Å—ã–ª–∞—é—Ç—Å—è –≤ —á–∏—Å—Ç–æ–º –≤–∏–¥–µ –±–µ–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö\n"
        "‚Ä¢ –ë–æ—Ç –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π\n\n"
        "_–î–ª—è –ø–æ–ª–Ω–æ–π –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç–∏ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å –±–æ—Ç–æ–º_"
    )
    bot.reply_to(message, privacy_text, parse_mode='Markdown')

# ========== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ==========

@bot.message_handler(func=lambda message: True, content_types=['text'])
def handle_text(message):
    try:
        # –û—Ç–≤–µ—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        bot.reply_to(message, "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–Ω–æ–Ω–∏–º–Ω–æ!", parse_mode='Markdown')
        
        # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –∞–¥–º–∏–Ω—É (–µ—Å–ª–∏ ADMIN_CHAT_ID —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
        if ADMIN_CHAT_ID:
            anonymous_msg = f"üì® *–ê–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:*\n\n`{message.text}`\n\n_ID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —Å–∫—Ä—ã—Ç_"
            bot.send_message(ADMIN_CHAT_ID, anonymous_msg, parse_mode='Markdown')
        
        print(f"üìù –ü–æ–ª—É—á–µ–Ω–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {message.text[:50]}...")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        bot.reply_to(message, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

@bot.message_handler(content_types=['photo'])
def handle_photo(message):
    try:
        bot.reply_to(message, "‚úÖ –§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–Ω–æ–Ω–∏–º–Ω–æ!")
        
        if ADMIN_CHAT_ID:
            # –ë–µ—Ä–µ–º —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ —Ñ–æ—Ç–æ
            photo_id = message.photo[-1].file_id
            caption = message.caption or "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"
            
            bot.send_photo(
                ADMIN_CHAT_ID, 
                photo_id,
                caption=f"üì∑ *–ê–Ω–æ–Ω–∏–º–Ω–æ–µ —Ñ–æ—Ç–æ:*\n\n`{caption}`\n\n_ID —Å–∫—Ä—ã—Ç_",
                parse_mode='Markdown'
            )
        
        print("üñºÔ∏è –ü–æ–ª—É—á–µ–Ω–æ —Ñ–æ—Ç–æ")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ç–æ: {e}")

@bot.message_handler(content_types=['video'])
def handle_video(message):
    try:
        bot.reply_to(message, "‚úÖ –í–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–Ω–æ–Ω–∏–º–Ω–æ!")
        
        if ADMIN_CHAT_ID:
            video_id = message.video.file_id
            caption = message.caption or "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"
            
            bot.send_video(
                ADMIN_CHAT_ID,
                video_id,
                caption=f"üé• *–ê–Ω–æ–Ω–∏–º–Ω–æ–µ –≤–∏–¥–µ–æ:*\n\n`{caption}`\n\n_ID —Å–∫—Ä—ã—Ç_",
                parse_mode='Markdown'
            )
        
        print("üé• –ü–æ–ª—É—á–µ–Ω–æ –≤–∏–¥–µ–æ")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ: {e}")

@bot.message_handler(content_types=['document', 'voice', 'audio', 'sticker'])
def handle_other(message):
    try:
        file_type = {
            'document': '–¥–æ–∫—É–º–µ–Ω—Ç üìé',
            'voice': '–≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ üé§',
            'audio': '–∞—É–¥–∏–æ üéµ',
            'sticker': '—Å—Ç–∏–∫–µ—Ä üòÑ'
        }.get(message.content_type, '—Ñ–∞–π–ª')
        
        bot.reply_to(message, f"‚úÖ {file_type.capitalize()} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–Ω–æ–Ω–∏–º–Ω–æ!")
        
        if ADMIN_CHAT_ID:
            caption = getattr(message, 'caption', '') or getattr(message, 'file_name', '') or ''
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
            notify_text = f"üìé *–ê–Ω–æ–Ω–∏–º–Ω—ã–π {file_type}:*\n\n`{caption}`\n\n_ID —Å–∫—Ä—ã—Ç_"
            bot.send_message(ADMIN_CHAT_ID, notify_text, parse_mode='Markdown')
            
            # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–ª–∞—Ç—å —Å–∞–º —Ñ–∞–π–ª, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
            # if message.document:
            #     bot.send_document(ADMIN_CHAT_ID, message.document.file_id)
        
        print(f"üìé –ü–æ–ª—É—á–µ–Ω {file_type}")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: {e}")

# ========== WEBHOOK –î–õ–Ø RENDER ==========

@app.route('/')
def index():
    return "ü§ñ –ê–Ω–æ–Ω–∏–º–Ω—ã–π –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Telegram –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π."

@app.route('/webhook', methods=['POST'])
def webhook():
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
        return ''
    return 'Bad request', 400

# ========== –ó–ê–ü–£–°–ö ==========

if __name__ == '__main__':
    print("=" * 50)
    print("ü§ñ –ó–∞–ø—É—Å–∫ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –±–æ—Ç–∞...")
    print(f"‚úÖ –¢–æ–∫–µ–Ω: {'—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' if TOKEN else '–ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!'}")
    print(f"‚úÖ –ê–¥–º–∏–Ω ID: {ADMIN_CHAT_ID if ADMIN_CHAT_ID else '–ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}")
    print("=" * 50)
    
    # –ù–∞ Render –∏—Å–ø–æ–ª—å–∑—É–µ–º Flask, –∞ –Ω–µ polling
    # –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=False)
